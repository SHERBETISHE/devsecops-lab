name: DevSecOps Pipeline (Split Jobs)

on: [push, pull_request]

jobs:
  # --- –†–ê–ë–û–¢–ê 1: –ü–†–û–í–ï–†–ö–ò –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò ---
  security-checks:
    name: üõ°Ô∏è Security Gates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 1. –ò—â–µ–º —Å–µ–∫—Ä–µ—Ç—ã
      - name: Secret Scanning (Gitleaks)
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 2. –ò—â–µ–º –¥—ã—Ä—ã –≤ Python-–∫–æ–¥–µ
      - name: SAST Scanning (Semgrep)
        uses: returntocorp/semgrep-action@v1
        with:
          config: p/security-audit

      # 3. –ò—â–µ–º —Å—Ç–∞—Ä—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ (—Å–∫–∞–Ω —Ñ–∞–π–ª–æ–≤)
      - name: Dependency Scanning (Trivy FS)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          ignore-unfixed: true
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL,HIGH'

  # --- –†–ê–ë–û–¢–ê 2: –°–ë–û–†–ö–ê –û–ë–†–ê–ó–ê ---
  build-image:
    name: üê≥ Build Docker Image
    runs-on: ubuntu-latest
    # üî• –í–û–¢ –ì–õ–ê–í–ù–ê–Ø –ú–ê–ì–ò–Ø:
    # –≠—Ç–æ—Ç job –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –¢–û–õ–¨–ö–û –µ—Å–ª–∏ security-checks –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ
    needs: [security-checks] 
    
    steps:
      # –í–∞–∂–Ω–æ: –ö–∞–∂–¥—ã–π job –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞ —á–∏—Å—Ç–æ–π –≤–∏—Ä—Ç—É–∞–ª–∫–µ, 
      # –ø–æ—ç—Ç–æ–º—É –∫–æ–¥ –Ω—É–∂–Ω–æ —Å–∫–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ.
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Build Docker Image
        run: |
          docker build -t my-secure-app:${{ github.sha }} .
          echo "‚úÖ Image built successfully"

      # (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –¢—É—Ç –º–æ–≥ –±—ã –±—ã—Ç—å —à–∞–≥ 'docker push', –µ—Å–ª–∏ –±—ã –º—ã –Ω–∞—Å—Ç—Ä–æ–∏–ª–∏ DockerHub
